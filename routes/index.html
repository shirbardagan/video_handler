<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synced Video Playback</title>
    <style>
        #messageContainer {
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            background-color: #f9f9f9;
        }
        .message {
            font-size: 14px;
            color: #333;
            margin-bottom: 5px;
            word-wrap: break-word;
        }
    </style>
</head>
<body id="body">
    <video id="video1" autoplay playsinline muted controls></video>

    <div>
        <button type="button" onClick="playClick()">Play</button>
    </div>

    <div id="messageContainer"></div> <!-- ✅ Messages appear here -->

    <script>
        let conn = new WebSocket('ws://' + window.location.host + '/ws');
        let pc = new RTCPeerConnection();
        let dataChannel = pc.createDataChannel("data");

        window.playClick = () => {
            console.log("Sending play event to server...");
            conn.send(JSON.stringify({ event: 'play', data: '' }));
        };

        pc.ontrack = function(event) {
            if (event.track.kind === 'video') {
                var el = document.getElementById('video1');
                el.srcObject = event.streams[0];
                el.autoplay = true;
                el.controls = true;
                el.onloadedmetadata = () => el.play();
            }
        };

        pc.onicecandidate = event => {
            if (event.candidate) {
                            console.log('Sending ICE candidate to server');
                 conn.send(JSON.stringify({
                     event: 'candidate',
                     data: event.candidate
                 }));
            } else {
                console.log('ICE candidate gathering complete');
            }
        };

        conn.onopen = () => {
            console.log('WebSocket connection opened, waiting for offer...');
        };

        conn.onclose = evt => {
            console.log('WebSocket connection closed');
        };

        conn.onmessage = async evt => {
            let msg = JSON.parse(evt.data);
            console.log('Received message:', msg);

            if (!msg) {
                return console.log('Failed to parse message');
            }
            if (!msg) return;

            switch (msg.event) {
                case 'offer':
                    console.log('Received offer from server');
                    await pc.setRemoteDescription(new RTCSessionDescription(msg.data));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    conn.send(JSON.stringify({ event: 'answer', data: answer }));
                    console.log('Sent SDP answer');
                    break;

                case 'candidate':
                    console.log('Received ICE candidate from server', msg.data);
                    try {
                        await pc.addIceCandidate(new RTCIceCandidate(msg.data));
                    } catch (error) {
                        console.error('Error adding ICE candidate:', error);
                    }
                    break;

                case 'video_data':
                    displayMessage(msg); // ✅ Call function to show messages
                    break;

                default:
                    console.log('Unknown event:', msg.event);
                    break;
            }
        };


        // Handle incoming DataChannel messages
        dataChannel.onmessage = event => {
            console.log('on data channel event!!!');
            let msg = JSON.parse(event.data);
            if (msg.event === "video_data") {
                displayMessage(msg);
            }
        };

        // Handle when a DataChannel is received
        pc.ondatachannel = event => {
            console.log('on data channel event!!!');
            let channel = event.channel;
            channel.onmessage = dataChannel.onmessage; // Set message handler
        };

        function sanitizeJSON(jsonString) {
            // Replace non-printable characters with an empty string
            return jsonString.replace(/[\x00-\x1F\x7F-\x9F]/g, "");
        }

        function displayMessage(msg) {
            const messageContainer = document.getElementById('messageContainer');

            // Clear previous message
            messageContainer.innerHTML = '';

            // Create a new message div
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            // Sanitize and format the JSON
            let displayText = sanitizeJSON(JSON.stringify(msg.data));
            try {
                // Prettify the JSON
                displayText = JSON.stringify(JSON.parse(displayText), null, 2);  // Prettify the JSON with indentation
            } catch (e) {
                displayText = `Error parsing JSON: ${e.message}`;
            }

            // Add timestamp and formatted JSON message to display
            messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ${displayText}`;

            // Add the new message to the container
            messageContainer.appendChild(messageDiv);
        }

        pc.onconnectionstatechange = () => {
            if (pc.connectionState === "failed") {
                console.error("Connection failed. Possible SDP mismatch or ICE failure.");
            }
            else {
                console.log("Connection state change:", pc.connectionState);
            }
        };
    </script>
</body>
</html>