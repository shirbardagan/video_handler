<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synced Video Playback</title>
    <style>
        #messageContainer {
            white-space: pre-wrap;  /* Ensures newlines and spaces are respected */
            font-family: 'Courier New', monospace;  /* Monospace font for better alignment */
            font-size: 14px; /* Optional: adjust font size */
            background-color: #f4f4f4; /* Optional: background color */
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            overflow: auto; /* Ensure long content doesn't overflow */
        }
        .message {
            margin-bottom: 10px;
            word-wrap: break-word;  /* Ensure long words break appropriately */
        }
    </style>

</head>
<body id="body">
    <video id="video1" autoplay playsinline muted controls></video>

    <div>
        <button type="button" onClick="playClick()">Play</button>
    </div>

    <div id="messageContainer"></div> <!-- ✅ Messages appear here -->

    <script>
        let conn = new WebSocket('ws://' + window.location.host + '/ws');
        let pc = new RTCPeerConnection();
        let dataChannel = pc.createDataChannel("data");

        window.playClick = () => {
            console.log("Sending play event to server...");
            conn.send(JSON.stringify({ event: 'play', data: '' }));
        };

        pc.ontrack = function(event) {
            if (event.track.kind === 'video') {
                var el = document.getElementById('video1');
                el.srcObject = event.streams[0];
                el.autoplay = true;
                el.controls = true;
                el.onloadedmetadata = () => el.play();
            }
        };

        pc.onicecandidate = event => {
            if (event.candidate) {
                console.log('Sending ICE candidate to server');
                conn.send(JSON.stringify({
                    event: 'candidate',
                    data: event.candidate
                }));
            } else {
                console.log('ICE candidate gathering complete');
            }
        };

        conn.onopen = () => {
            console.log('WebSocket connection opened, waiting for offer...');
        };

        conn.onclose = evt => {
            console.log('WebSocket connection closed');
        };

        conn.onmessage = async evt => {
            let msg = JSON.parse(evt.data);
            console.log('Received message:', msg);

            if (!msg) {
                return console.log('Failed to parse message');
            }

            switch (msg.event) {
                case 'offer':
                    console.log('Received offer from server');
                    await pc.setRemoteDescription(new RTCSessionDescription(msg.data));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    conn.send(JSON.stringify({ event: 'answer', data: answer }));
                    console.log('Sent SDP answer');
                    break;

                case 'candidate':
                    console.log('Received ICE candidate from server', msg.data);
                    try {
                        await pc.addIceCandidate(new RTCIceCandidate(msg.data));
                    } catch (error) {
                        console.error('Error adding ICE candidate:', error);
                    }
                    break;

                case 'video_data':
                    displayMessage(msg); // ✅ Call function to show messages
                    break;

                default:
                    console.log('Unknown event:', msg.event);
                    break;
            }
        };

        dataChannel.onmessage = event => {
            let msg = JSON.parse(event.data);
            if (msg.event === "video_data") {
                displayMessage(msg);
            }
        };

        pc.ondatachannel = event => {
            let channel = event.channel;
            channel.onmessage = dataChannel.onmessage; // Set message handler
        };

        function sanitizeJSON(jsonString) {
            // Remove non-UTF-8 characters or any other unwanted characters
            return jsonString.replace(/[\x00-\x1F\x7F-\x9F\uFFFD]/g, "");
        }

        function displayMessage(msg) {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML = '';  // Clear previous messages

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            // Step 1: Log the raw message data
            console.log("Raw msg.data:", msg.data);

            // Step 2: Remove any leading timestamp (e.g., [5:30:04 PM])
            let displayText = msg.data.replace(/^\[.*?\]\s*/, ''); // Regex removes leading timestamp

            // Step 3: Clean any unwanted control characters that might break JSON structure
            displayText = sanitizeJSON(displayText);

            // Step 4: Clean up rvt_local_set field specifically (if needed)
            try {
                const parsedData = JSON.parse(displayText); // Parse the JSON string
                if (parsedData.rvt_local_set) {
                    parsedData.rvt_local_set = sanitizeJSON(parsedData.rvt_local_set); // Clean the rvt_local_set field
                }

                // Step 5: Prettify JSON with 2 spaces
                displayText = JSON.stringify(parsedData, null, 2);
            } catch (e) {
                // If JSON parsing fails, display the error message
                console.error("JSON parsing error:", e.message);
                displayText = `Error parsing JSON: ${e.message}`;
            }

            // Step 6: Display the prettified or error message with timestamp
            messageDiv.textContent = `[${new Date().toLocaleTimeString()}]\n` + displayText;
            messageContainer.appendChild(messageDiv);
        }





        pc.onconnectionstatechange = () => {
            if (pc.connectionState === "failed") {
                console.error("Connection failed. Possible SDP mismatch or ICE failure.");
            }
            else {
                console.log("Connection state change:", pc.connectionState);
            }
        };
    </script>
</body>
</html>
