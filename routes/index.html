<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synced Video Playback</title>
    <style>
        #messageContainer {
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            background-color: #f9f9f9;
        }
        .message {
            font-size: 14px;
            color: #333;
            margin-bottom: 5px;
            word-wrap: break-word;
        }
    </style>
</head>
<body id="body">
    <video id="video1" autoplay playsinline muted controls></video>

    <div>
        <button type="button" onClick="playClick()">Play</button>
    </div>

    <div id="messageContainer"></div> <!-- ✅ Messages appear here -->

    <script>
        let conn = new WebSocket('ws://' + window.location.host + '/ws');
        let pc = new RTCPeerConnection();

        window.playClick = () => {
            console.log("Sending play event to server...");
            conn.send(JSON.stringify({ event: 'play', data: '' }));
        };

        pc.ontrack = function(event) {
            if (event.track.kind === 'video') {
                var el = document.getElementById('video1');
                el.srcObject = event.streams[0];
                el.autoplay = true;
                el.controls = true;
                el.onloadedmetadata = () => el.play();
            }
        };

        pc.onicecandidate = event => {
            if (event.candidate) {
                conn.send(JSON.stringify({ event: 'candidate', data: event.candidate }));
            }
        };

        conn.onmessage = async evt => {
            let msg = JSON.parse(evt.data);
            if (!msg) return;

            switch (msg.event) {
                case 'offer':
                    await pc.setRemoteDescription(new RTCSessionDescription(msg.data));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    conn.send(JSON.stringify({ event: 'answer', data: answer }));
                    break;

                case 'candidate':
                    try { await pc.addIceCandidate(new RTCIceCandidate(msg.data)); }
                    catch (error) { console.error('Error adding ICE candidate:', error); }
                    break;

                case 'video_data':
                    displayMessage(msg); // ✅ Call function to show messages
                    break;

                default:
                    console.log('Unknown event:', msg.event);
                    break;
            }
        };

        function sanitizeJSON(jsonString) {
            // Replace non-printable characters with an empty string
            return jsonString.replace(/[\x00-\x1F\x7F-\x9F]/g, "");
        }

        function displayMessage(msg) {
            const messageContainer = document.getElementById('messageContainer');

            // Clear previous message
            messageContainer.innerHTML = '';

            // Create a new message div
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            // Sanitize and format the JSON
            let displayText = sanitizeJSON(JSON.stringify(msg.data));
            try {
                // Prettify the JSON
                displayText = JSON.stringify(JSON.parse(displayText), null, 2);  // Prettify the JSON with indentation
            } catch (e) {
                displayText = `Error parsing JSON: ${e.message}`;
            }

            // Add timestamp and formatted JSON message to display
            messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ${displayText}`;

            // Add the new message to the container
            messageContainer.appendChild(messageDiv);
        }

        pc.onconnectionstatechange = () => {
            if (pc.connectionState === "failed") {
                console.error("Connection failed. Possible SDP mismatch or ICE failure.");
            }
        };
    </script>
</body>
</html>
